name: Project Board Automation

# IMPORTANT: This workflow requires the following configuration to work with user-level projects:
#
# 1. Create a Personal Access Token (PAT) with 'project' scope:
#    - Go to: https://github.com/settings/tokens
#    - Generate new token (classic)
#    - Select scope: 'project' (read:project and write:project)
#    - Copy the token
#
# 2. Add the PAT as a repository secret:
#    - Go to: https://github.com/mikelane/previewd/settings/secrets/actions
#    - Name: PROJECT_PAT
#    - Value: [paste your PAT]
#
# 3. Enable project automation:
#    - Go to: https://github.com/mikelane/previewd/settings/variables/actions
#    - Create variable: PROJECT_AUTOMATION_ENABLED
#    - Value: true
#
# Note: GITHUB_TOKEN cannot access user-level projects, only org-level projects.
# If these secrets/vars are not configured, the project board steps will be skipped.

on:
  pull_request:
    types: [opened, ready_for_review, review_requested, closed]
  pull_request_review:
    types: [submitted]
  issues:
    types: [opened, closed, assigned]

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  update-project:
    runs-on: ubuntu-latest
    steps:
      - name: Add issue/PR to project
        if: github.event.action == 'opened' && vars.PROJECT_AUTOMATION_ENABLED == 'true'
        uses: actions/add-to-project@v1.0.2
        with:
          project-url: https://github.com/users/mikelane/projects/3
          github-token: ${{ secrets.PROJECT_PAT }}

      - name: Move to Code Review when PR opened
        if: github.event_name == 'pull_request' && github.event.action == 'opened'
        uses: actions/github-script@v8
        with:
          script: |
            const pr = context.payload.pull_request;

            // Add workflow label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['workflow: ready-for-review']
            });

            // Comment on PR with workflow instructions
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: `## ðŸ¤– Workflow Automation\n\nThis PR has been moved to **Code Review** stage on the project board.\n\n**Next Steps:**\n1. âœ… Automated checks must pass\n2. ðŸ‘€ Code review approval required\n3. ðŸ§ª QA review required\n4. ðŸš€ SRE review (if infrastructure changes)\n\nSee [CONTRIBUTING.md](../CONTRIBUTING.md#pull-request-process) for details.`
            });

      - name: Move to QA Review when code approved
        if: github.event_name == 'pull_request_review' && github.event.review.state == 'approved'
        uses: actions/github-script@v8
        with:
          script: |
            const pr = context.payload.pull_request;

            // Remove code review label, add QA review label
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              name: 'workflow: ready-for-review'
            }).catch(() => {});

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['workflow: needs-qa']
            });

            // Comment on PR
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: `## âœ… Code Review Approved\n\nMoving to **QA Review** stage.\n\n@mikelane - Please perform QA validation:\n- Run full test suite\n- Security audit\n- Validate acceptance criteria\n- Test edge cases\n\nSee [PRODUCT_LIFECYCLE.md](../docs/PRODUCT_LIFECYCLE.md#6-qa-review) for QA checklist.`
            });

      - name: Auto-close linked issues when PR merged
        if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged
        uses: actions/github-script@v8
        with:
          script: |
            const pr = context.payload.pull_request;

            // Extract issue numbers from PR body
            const issueNumbers = (pr.body || '').match(/(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s+#(\d+)/gi);

            if (issueNumbers) {
              for (const match of issueNumbers) {
                const issueNumber = parseInt(match.match(/\d+/)[0]);

                // Close the issue
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  state: 'closed'
                });

                // Add comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: `Automatically closed by merged PR #${pr.number}`
                });
              }
            }

      - name: Auto-assign based on CODEOWNERS
        if: github.event_name == 'pull_request' && github.event.action == 'opened'
        uses: actions/github-script@v8
        with:
          script: |
            // For now, auto-assign to mikelane
            // TODO: Parse CODEOWNERS file when more contributors
            await github.rest.pulls.requestReviewers({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              reviewers: ['mikelane']
            });

      - name: Move to Done when issue closed
        if: github.event_name == 'issues' && github.event.action == 'closed' && vars.PROJECT_AUTOMATION_ENABLED == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.PROJECT_PAT }}
          PROJECT_NUMBER: 3
          ORGANIZATION: mikelane
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.PROJECT_PAT }}
          script: |
            const issue = context.payload.issue;

            // Query to find the project item and update status
            const mutation = `
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $valueId: String!) {
                updateProjectV2ItemFieldValue(
                  input: {
                    projectId: $projectId
                    itemId: $itemId
                    fieldId: $fieldId
                    value: { singleSelectOptionId: $valueId }
                  }
                ) {
                  projectV2Item {
                    id
                  }
                }
              }
            `;

            const query = `
              query($org: String!, $projectNumber: Int!, $issueId: ID!) {
                user(login: $org) {
                  projectV2(number: $projectNumber) {
                    id
                    field(name: "Status") {
                      ... on ProjectV2SingleSelectField {
                        id
                        options {
                          id
                          name
                        }
                      }
                    }
                    items(first: 100) {
                      nodes {
                        id
                        content {
                          ... on Issue {
                            id
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            try {
              // Get project data
              const projectData = await github.graphql(query, {
                org: process.env.ORGANIZATION,
                projectNumber: parseInt(process.env.PROJECT_NUMBER),
                issueId: issue.node_id
              });

              const project = projectData.user.projectV2;
              const statusField = project.field;
              const doneOption = statusField.options.find(opt => opt.name === 'Done');

              if (!doneOption) {
                console.log('Warning: "Done" status not found in project. Available options:', statusField.options.map(o => o.name));
                return;
              }

              // Find the project item for this issue
              const projectItem = project.items.nodes.find(
                item => item.content && item.content.id === issue.node_id
              );

              if (!projectItem) {
                console.log('Issue not found in project board, skipping status update');
                return;
              }

              // Update the status to Done
              await github.graphql(mutation, {
                projectId: project.id,
                itemId: projectItem.id,
                fieldId: statusField.id,
                valueId: doneOption.id
              });

              console.log(`Updated issue #${issue.number} status to Done in project board`);

            } catch (error) {
              console.error('Error updating project board:', error);
              // Don't fail the workflow if project board update fails
            }
